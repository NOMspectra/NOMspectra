# Masslib GUI

Property of natural humic substances laboratory. Chemistry Department of Lomonosov Moscow State University. 
It is forbidden to distribute this script without permission of the head of the laboratory.
Authors: Rukhovich Gleb, Volikov Alexander


## Установка и запуск

Для работы с программой необходимо установить python и необходимые пакеты. Можно скачать python с официального сайта и далее через pip установить нужные компоненты. Для этого в командной строчке вбить:

`pip install pyqt5 matplotlib numpy pandas scikit-learn scipy seaborn tqdm matplotlib-venn`

Далее запустить программу можно из терминала с помощью команды:

`python masslib_gui.py`

Либо из контекстного меню – правый клик мыши, открыть с помощью idle (или другое IDE для открытия файлов pyrhon). Из IDE запустить выполнения скрипта. Также как любой питон-скрипт. Спектры открывать и сохранять можно произвольно на компьютере.

## Загрузка спектра

Загрузить можно новый спектр без приписки либо уже ранее обработанный спектр.
Для загрузки нового спектра нужно выбрать галочку **new** а также вбить разделить, который используется в файле, если разделитель **таб** – вбить **tab** , запятая как запятая , и т.д, а также заголовки для m/z и интенсивности в точности также как в файле.

Если открывается файл уже ранее обработанный этой программа, то там, как правило используются стандартные заголовки и разделитель, поэтому их указывать не обязательно.
При открытии спектра можно задать ограничения по массе и интенсивности в соответствующих полях.

Спектр можно сохранить – открывается диалоговое окно, сохраняется таблица в текстовом виде. Также его можно посмотреть без сохранения в любой момент по кнопке **Print Spectrum** , первые и последние пять строчек таблицы отразится в поле ниже. Это можно сделать в любой момент обработки спектра для контроля.

## Генерация брутто формул и приписывание спектра

По умолчанию используется следующий диапазон элементов: С (от 1 до 59), O (от 0 до 59), H (0-99), N(0-2), S(0-1). Также используются ограничения для H/C (0.25-2.2), O/C (0-1), а также азотное правило.

Для просмотра стандартной выборки или для возвращения к ней – нажать **Reset** .
Если мы хотим задать другой набор элементов и их диапазон, то их нужно добавлять по одному через соответствующие поля. Если элемент основной, то можно оставить поле **Isotope** пустым (например, для углерода 12 – просто вбить элемент C), для конкретных изотопов заполнить соответствующее поля (например, С 13). Заполнить диапазон от до. Нажать **Add** , отразиться текущий набор. После этого последовательно добавить все нужные элементы. Для генерации брутто формул нажать **Generate** , таблица отразится в поле ниже. После этого можно приписывать формулы – нажать кнопку **Assign** .

Можно загрузить фон и удалить его. Но для этого необходимо использовать фон, к которому также приписаны формулы – его следует обработать также как спектр и сохранить в отдельный файл.

Можно сгенерировать спектр статистики разницы масс (TMDS) элементы для его генерации задаются так же как для приписки спектра. Имеет смысл задать стартовые значения -1 -4 для элементов, поскольку многие разницы включают отрицательные значения, например, C-1H4O.
Затем нужно задать порог встречаемости пиков в спектре разницы масс. По умолчанию стоит 0.2, но с данными условиями генерируется порядка 1000 разниц масс и последующее прпиписывание исходного спектра занимает много времени (10-30 минут). Можно попробовать использовать большие значения в зависимости от числа разниц масс (p=0.6, 0.7...)

После генерации TMDS можно им воспользоваться и приписать дополнительные пики в спектре с помощью соотвутствующей кнопки

## Построение спектра и диаграмм Ван-Кревелена

После загрузки обработанного спектра или приписывания сырого можно построить спектр с соответствующей кнопкой **Plot Spectrum** . Откроется новое окно, в нём можно оперировать спектром – выделять область, увеличивать, двигать и т.д. Можно сохранить картинку в png.

Ван-кревелен можно построить соответствующей кнопкой. В нём можно выделить серу и азот стандартными цветами (галочки стоят по умолчанию), либо можно выделить произвольный элемент пурпуным цветом – вбить в советующее поле. Если хотим изотоп – через нижнее подчеркивания, например, C_13, O_18. 

Также можно построить плотностный ван-кревелен. Или карту заселенности – **Square Density Plot**. Можно сохранить заселенность в файл.

## Логические операции со двумя спектрами

Спектры можно складывать, вычитать, находить общее, а также считать метрики схожести.
Лучше всего работать с уже обработанными спектрами. Главные спектр загружаем через **Load Spectrum** , второй через **Load second spectrum** . Выбираем операцию и нажимаем **Operate**. Результат можно посмотреть через построение ван-кревелина. Метрики отобразятся в окне ниже. При этом спектр-результат операции сохранится в кеше, с ним можно продолжать выполнять операции.

## Перекаллибровка

Спектр можно перекаллибровать разными методами

- По эталону. Для этого открыть обработанный программой эталонный спектр **Load Etalon**, нажимаем **Calc Recal by Etalon**, отобразится ход ошибки. После этого можно нажать **recalibrate**, после чего массы в спектре изменяться, нужно переприписать формулы через **Assign**

- аналогично можно посчитать перекаллибровку по ошибке приписывания или по карте разностей масс с помощью соответствующих кнопок.

Ошибку можно применить не на весь спектр, а на часть, для этого нужно вбить диапазон, нажать **Range** и **Extrapolate**. Уже один раз посчитанную ошибку можно применить на другие спектры – загрузить или сохранить в файл. Можно загрузить таблицу ошибок каллибранта.

Ошибку приписывания можно и необходимость операции перекаллибровки можно оценить по кнопке **show assign error**